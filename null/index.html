<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="性能测试与性能分析的价值"><meta name="keywords" content=""><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><title>性能测试与性能分析的价值 | Hexo</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.1.0'
} </script><meta name="generator" content="Hexo 6.1.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E9%9C%80%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">1 性能测试需求</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E6%8A%80%E8%83%BD%E6%A0%91"><span class="toc-number">1.1.</span> <span class="toc-text">性能测试技能树</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%B8%B8%E8%A7%81%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%89%96%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">2 常见性能测试剖析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E8%A1%8C%E4%B8%9A%E6%B5%81%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">3.</span> <span class="toc-text">3 行业流行性能测试工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E8%A1%8C%E4%B8%9A%E6%B5%81%E8%A1%8C%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7"><span class="toc-number">4.</span> <span class="toc-text">4 行业流行性能监控工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#top"><span class="toc-number">4.1.</span> <span class="toc-text">top</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nmon"><span class="toc-number">4.2.</span> <span class="toc-text">Nmon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Collectd-InfluxDB-Grafana"><span class="toc-number">4.3.</span> <span class="toc-text">Collectd+InfluxDB+Grafana</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus"><span class="toc-number">4.4.</span> <span class="toc-text">Prometheus</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E8%A1%8C%E4%B8%9A%E6%B5%81%E8%A1%8C%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-number">5.</span> <span class="toc-text">5 行业流行性能剖析工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%80%A7%E8%83%BD%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1"><span class="toc-number">6.</span> <span class="toc-text">6 性能方案设计</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9%E6%80%A7%E8%83%BD%E7%9A%84%E6%9C%9F%E6%9C%9B"><span class="toc-number">7.</span> <span class="toc-text">对性能的期望</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E7%A0%94%E7%A9%B6%E9%83%A8%E5%88%86"><span class="toc-number">8.</span> <span class="toc-text">技术研究部分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E4%BB%B7%E5%80%BC"><span class="toc-number">9.</span> <span class="toc-text">性能测试价值</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">John Doe</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">4</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Hexo</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Posts</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">性能测试与性能分析的价值</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-30</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="1-性能测试需求"><a href="#1-性能测试需求" class="headerlink" title="1 性能测试需求"></a>1 性能测试需求</h1><p>有效的性能测试能给研发，运维团队提供有效的</p>
<p>容量规划能力</p>
<p>系统风险识别</p>
<p>系统瓶颈识别</p>
<p>性能调优指导</p>
<p>保障尽量避免性能问题的发生</p>
<p>假设某外卖日订单量3000W,客单价30元，中午宕机十分钟造成的损失（外卖80%单量集中在中午和晚上4小时内）：</p>
<p>单量损失10x3000Wx80%&#x2F;（4x60）&#x3D;100W</p>
<p>金额损失100Wx30&#x3D;3000W</p>
<p>我扩机器解决性能问题不行么？</p>
<p>查看阿里云服务器报价，机器成本并不是小数目，而且不是所有的服务器都可以水平扩容，依赖性能测试发现优化点。</p>
<p>良好的容量规划能力+性能调优能力 &#x3D; 为老板省钱</p>
<h2 id="性能测试技能树"><a href="#性能测试技能树" class="headerlink" title="性能测试技能树"></a>性能测试技能树</h2><table>
<thead>
<tr>
<th>性能测试与分析优化</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>操作系统OS</td>
</tr>
<tr>
<td></td>
<td>数据库</td>
</tr>
<tr>
<td></td>
<td>存储</td>
</tr>
<tr>
<td></td>
<td>应用服务器&#x2F;中间件</td>
</tr>
<tr>
<td></td>
<td>网络</td>
</tr>
<tr>
<td></td>
<td>压力测试</td>
</tr>
<tr>
<td></td>
<td>监控分析工具</td>
</tr>
<tr>
<td></td>
<td>缓存</td>
</tr>
<tr>
<td></td>
<td>队列</td>
</tr>
<tr>
<td></td>
<td>web服务器</td>
</tr>
<tr>
<td></td>
<td>容器化&#x2F;编排&#x2F;网格</td>
</tr>
<tr>
<td></td>
<td>大数据技术</td>
</tr>
<tr>
<td></td>
<td>代码调优</td>
</tr>
</tbody></table>
<h1 id="2-常见性能测试剖析"><a href="#2-常见性能测试剖析" class="headerlink" title="2 常见性能测试剖析"></a>2 常见性能测试剖析</h1><p>服务宕机：服务单点性能问题</p>
<p>​    系统资源问题：CPU、内存、磁盘、网络、…</p>
<p>​    语言&#x2F;代码：JVM，PHP-fpm…</p>
<p>​    框架问题：Spring Boot&#x2F;百度RPC…</p>
<p>案例1：某次压力测试，服务端cpu（计算型cpu）飙升打满</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">top -H -p pid </span><br><span class="line">pstack pid</span><br><span class="line">trace -p pid</span><br><span class="line">分析代码/架构/死锁问题</span><br></pre></td></tr></table></figure>

<p>案例2：某次压力测试，系统CPU等指标较正常，但偶发间断时间请求耗时特别高</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">分析JVM GC问题</span><br><span class="line">减少FullGC时间，老年代降低</span><br></pre></td></tr></table></figure>

<p>案例3：某次压力测试，php程序，php-fpm内存增长，OOM导致服务挂掉</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">排查原因，使用第三方so插件做JSON解析，但so插件有内存泄漏问题</span><br></pre></td></tr></table></figure>

<p>案例4：某次压力测试，CPU&#x2F;内存&#x2F;网络 等指标表现良好，但是响应耗时非常久</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">监控查看磁盘IO异常，追查发现日志级别为Debug,大量日志打印拖累性能</span><br><span class="line">查看nginx日志，发现request_time较长，upstream_response_time实际较短</span><br></pre></td></tr></table></figure>



<p>系统级性能问题</p>
<p>​    存储问题：Mysql&#x2F;redis&#x2F;memcache…</p>
<p>​    中间件问题：tomcat，http…</p>
<p>​    消息队列问题：Kafka，Active MQ…</p>
<p>​    调用链路问题：内部依赖，第三方依赖…</p>
<p>案例5：某次压力测试，同样并发TPS，但前期性能良好，后期数据库cpu飙升</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">压测会产生大量数据，数据增长会带来性能的损耗</span><br><span class="line">压测数据不合理，导致统一设备关联多个用户，服务端不做限制的in查询</span><br><span class="line">不合理分页，未做页数limit，导致将数据库新增数据全部查询</span><br></pre></td></tr></table></figure>

<p>案例6：某次稳定性测试，大并发TPS，前期性能良好，分片缓存，在模拟缓存单点失效后大量数据库穿透</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">缓存不合理的分片策略，使用除模方式，导致大量缓存统一时间失效。</span><br><span class="line">不合理的负载均衡算法也会有类似问题</span><br><span class="line">一致性hash解决缓存问题</span><br></pre></td></tr></table></figure>

<p>案例7：某次稳定性测试，如果HTTP入口流量仅百QPS，但下游RPC服务打挂</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">商户列表的请求，For循环调用下游解决，导致请求数百倍扩大</span><br><span class="line">解决方案：使用batch接口减轻压力，batch接口可能带来的功能隐患</span><br></pre></td></tr></table></figure>



<h1 id="3-行业流行性能测试工具"><a href="#3-行业流行性能测试工具" class="headerlink" title="3 行业流行性能测试工具"></a>3 行业流行性能测试工具</h1><ul>
<li>Apache AB</li>
<li>Apache JMeter</li>
<li>LoadRunner</li>
<li>Ngrinder(java)</li>
<li>Locust(python)</li>
<li>Ali PTS</li>
</ul>
<p>工具选型：</p>
<p>压测场景：单接口 or 复杂事务 —-  AB  or  Jmeter场景构造</p>
<p>压力需求：1000QPS or 万级以上 —-  Jmeter分布式支持</p>
<p>是否周期性：Jmeter Jmx场景文件，数据驱动，结果落库</p>
<p>二次开发需求：Jmeter开源插件化思想。</p>
<p>问题支持：Jmeter开放社区</p>
<h1 id="4-行业流行性能监控工具"><a href="#4-行业流行性能监控工具" class="headerlink" title="4 行业流行性能监控工具"></a>4 行业流行性能监控工具</h1><ul>
<li>Linux自带命令Vmstat，top等</li>
<li>机器监控工具nmon</li>
<li>物理机监控collectd+InfluxDB+Grafana</li>
<li>Docker+Mysql+redis一体化监控：Prometheus+Grafana（node_exporter,mysqld_exporter,redis_exporter,自定义exporter，全家桶）</li>
<li>全链路Tracing监控，zipkin</li>
</ul>
<h2 id="top"><a href="#top" class="headerlink" title="top"></a>top</h2><p><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20220330150917026.png" alt="image-20220330150917026"></p>
<p>上方显示的是机器的整体负载，下方展示的是每个PID下的请求</p>
<p>%cpu: 0.1us 表示用户态的cpu百分比</p>
<p>%cpu: 0.1sy 表示内核态的cpu百分比</p>
<p>%cpu: 0.0ni 表示用户进程空间内改变过优先级的进程占用CPU百分比</p>
<p>%cpu: 99.8id 表示空闲的CPU百分比（idle）</p>
<p>%cpu: 0.1wa 表示io wait的cpu百分比(wait)</p>
<p>PID：进程号</p>
<p>USER：所属用户</p>
<p>PR：优先级</p>
<p>NI：正值表示较高的优先级，负值表示较低的优先级</p>
<h2 id="Nmon"><a href="#Nmon" class="headerlink" title="Nmon"></a>Nmon</h2><h2 id="Collectd-InfluxDB-Grafana"><a href="#Collectd-InfluxDB-Grafana" class="headerlink" title="Collectd+InfluxDB+Grafana"></a>Collectd+InfluxDB+Grafana</h2><h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><h1 id="5-行业流行性能剖析工具"><a href="#5-行业流行性能剖析工具" class="headerlink" title="5 行业流行性能剖析工具"></a>5 行业流行性能剖析工具</h1><p><strong>系统级网络级监控及剖析工具</strong></p>
<ul>
<li>系统级命令</li>
<li>Prometheus</li>
<li>zabbix</li>
<li>Nmon</li>
<li>Nagios</li>
<li>Cacti</li>
<li>Graphite</li>
<li>Bosun</li>
<li>Ganglia</li>
</ul>
<p><strong>代码级监控及剖析工具</strong>-java</p>
<ul>
<li>Jconsole</li>
<li>JvirsualVM</li>
<li>JMC</li>
<li>Jstack</li>
<li>Jmap</li>
<li>jhat</li>
<li>jdb</li>
<li>Arthus</li>
<li>Btrace</li>
<li>jstat</li>
</ul>
<p>DB级监控及剖析工具</p>
<p>链路级监控及剖析工具</p>
<p>缓存，队列…etc</p>
<h1 id="6-性能方案设计"><a href="#6-性能方案设计" class="headerlink" title="6 性能方案设计"></a>6 性能方案设计</h1><p>需求分析与测试设计</p>
<ol>
<li>根据具体的性能测试需求，确定测试类型以及压测的模块（web&#x2F;mysql&#x2F;redis&#x2F;系统整体）</li>
<li>前期要与相关人员充分沟通，初步确定压测方案及具体性能指标</li>
<li>QA完成性能测试设计后，需产出测试方案文档发送邮件到项目组，并且再次与相关人员沟通（或者组织性能测试评审），确认是否满足需求</li>
</ol>
<p>环境设计与搭建</p>
<ol>
<li>根据不同类型使用线下压测场景（自己准备机器，自己部署环境）&#x2F;线上压测场景（全链路压测场景）</li>
</ol>
<p>测试数据准备和构造</p>
<ol>
<li>接口请求参数：自己构造&#x2F;日志获取&#x2F;上下关联</li>
<li>数据表的数据填充</li>
<li>如果是多接口，则需结合业务场景设计请求比例</li>
</ol>
<p>性能指标预期</p>
<ol>
<li>每秒请求数（QPS）</li>
<li>请求响应时间（最小，最大，平均）</li>
<li>错误率</li>
<li>机器性能：cpu idle 30%，memory无剧烈抖动或飙升</li>
<li>压测过程接口功能是否正常</li>
</ol>
<p>发压工具配置及脚本编写</p>
<ol>
<li>发压工具：JMeter</li>
<li>脚本的编写</li>
<li>启压命令.&#x2F;jmeter -n -t hb.jmx -l hb.jtl</li>
</ol>
<p>测试过程说明&#x2F;共识</p>
<ol>
<li>测试前环境检查：记录机器参数</li>
<li>启压：根据被压情况，调节并发量到适合的情况</li>
<li>记录各项性能指标<ol>
<li>nginx日志查看每秒请求数</li>
<li>查看nginx错误请求</li>
<li>查看机器参数：cpu idle，mem等</li>
<li>查看db，cache等数据是否写入正常</li>
<li>访问接口，查看功能是否正常</li>
</ol>
</li>
</ol>
<p>结果分析与测试报告</p>
<ol>
<li>根据测试过程中记录的各项参数，结合压测工具产生的日志，对测试结果进行分析，并产出测试报告</li>
<li>测试完成后，及时与相关人员沟通，确认是否满足需求</li>
<li>发送测试报告邮件</li>
</ol>
<h1 id="对性能的期望"><a href="#对性能的期望" class="headerlink" title="对性能的期望"></a>对性能的期望</h1><p>引：拿到一份性能测试报告，上面罗列了响应时间，tps，压力机基本配置情况，那么该如何判断性能测试的有效性？比如：</p>
<ol>
<li>场景是否合理</li>
<li>压力是否传递均匀或者达到指定目标</li>
<li>是否有干扰因素，或者说如何判断哪些数据是有效的</li>
<li>有没有一些判断手段？</li>
</ol>
<p>我们一般测完给出这样的性能测试报告就结束了吗？</p>
<p>期望：找到性能瓶颈？找到系统容量？给开发，运维提出建议？满足生产业务性能需求？</p>
<p>只测不调是没有一点价值的。在一个系统中已经界定了目标响应时间，界定了目标的TPS，最大的TPS。那么最终的测试报告中除了要有数据的体现，更重要的是给出证据体现分析的过程，最终给出一个配置建议文档。最好对线上的主机有一个明确的规划。</p>
<h1 id="技术研究部分"><a href="#技术研究部分" class="headerlink" title="技术研究部分"></a>技术研究部分</h1><p>分析压力测试工具：LR，jmeter，其他工具</p>
<ol>
<li>线程递增曲线</li>
<li>tps曲线</li>
<li>响应时间曲线</li>
<li>PS：如果有错就看错误率的曲线</li>
</ol>
<h1 id="性能测试价值"><a href="#性能测试价值" class="headerlink" title="性能测试价值"></a>性能测试价值</h1><ol>
<li>性能测试与性能分析的结果要有明确的<strong>数据证明</strong>调优的效果</li>
<li>性能测试与性能分析的价值要体现在具体的<strong>性能提升</strong>上</li>
<li>性能测试与性能分析的价值要体现在<strong>成本</strong>中</li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://1.13.196.91/null/">http://1.13.196.91/null/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="next-post pull-right"><a href="/undefined/"><span></span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By John Doe</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>